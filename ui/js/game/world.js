/* global stephino_rpg_tools, stephino_rpg_data */
// Game:World
jQuery(document).ready(function () { var worldObject = jQuery('[data-role="map-holder"]'); var mapCoordinates = { x: parseInt(worldObject.attr('data-start-x'), 10), y: parseInt(worldObject.attr('data-start-y'), 10) }; if (isNaN(mapCoordinates.x)) { mapCoordinates.x = 0; } if (isNaN(mapCoordinates.y)) { mapCoordinates.y = 0; } stephino_rpg_tools.ajax( 'cellsWorld', { x: mapCoordinates.x, y: mapCoordinates.y, radius: 6 }, function(msg) { if (!msg.status) {return;} var info = msg.result; var mapHandler = stephino_rpg_tools.map.init( worldObject, jQuery('[data-role="map"]'), { cells: info.grid, marginTop: 150, marginBottom: 150, marginLeft: 50, marginRight: 50, cellsRotated: true, cellPaddingTop: 1, cellPaddingBottom: 1, cellPaddingLeft: 1, cellPaddingRight: 1, zoomInitial: 1, centerCellX: mapCoordinates.x, centerCellY: mapCoordinates.y, trackerAttr: 'island-own', cellController: function(cellObject, payload) { if ("undefined" !== typeof payload.island_config_id) { cellObject.addClass('island-' + payload.island_config_id); } var itemsHolder = jQuery('<div class="items-holder"></div>'); var itemsHolderEmpty = true; var statuePosition = null; if ("undefined" !== typeof payload._islandStatueSlot && "undefined" !== typeof payload.island_statue_config_id) { statuePosition = { top: ((payload._islandHeight - 1) / 2 - payload._islandStatueSlot[1]) / (payload._islandHeight - 1) * 392 + 34, left: ((payload._islandWidth - 1) / 2 + payload._islandStatueSlot[0]) / (payload._islandWidth - 1) * 460 - 6 }; var statueObject = jQuery('<div class="statue statue-' + payload.island_statue_config_id + '"><i></i></div>').css(statuePosition); statueObject.children('i').html(`${payload._cities}/${jQuery.isArray(payload._citySlots) ? payload._citySlots.length : '?'}`); itemsHolder.append(statueObject); itemsHolderEmpty = false; } if ('undefined' !== typeof payload._citySlots && jQuery.isArray(payload._citySlots)) { payload._citySlots.forEach(function(pair){ var cityPosition = { top: ((payload._islandHeight - 1) / 2 - pair[1]) / (payload._islandHeight - 1) * 392 + 34, left: ((payload._islandWidth - 1) / 2 + pair[0]) / (payload._islandWidth - 1) * 460 - 6 }; var cityObject = jQuery('<div class="slot vacant"></div>').css(cityPosition); itemsHolder.append(cityObject); itemsHolderEmpty = false; }); } if ("object" === typeof payload.anim && null !== payload.anim) { payload.anim.forEach(function(animationId){ itemsHolder.append(jQuery('<div><div></div></div>').attr('anim', 'islands-' + payload.island_config_id + '-w-' + animationId)); itemsHolderEmpty = false; }); } var labelObject = jQuery('<div class="label"><span>' + payload.island_name + '</span></div>'); if (null !== statuePosition) { labelObject.css(statuePosition); } itemsHolder.append(labelObject); if ("undefined" !== typeof payload.island_id) { cellObject.attr('island-id', payload.island_id); } if ("undefined" !== typeof payload.island_name) { cellObject.attr('title', payload.island_name); } if ("undefined" !== typeof payload._islandOwn) { cellObject.attr('island-own', 'true'); } if (!itemsHolderEmpty) { cellObject.append(itemsHolder); } return !itemsHolderEmpty; }, cellTap: function(targetObject) { var cell = targetObject.hasClass('cell') ? targetObject : targetObject.parents('.cell'); if ("undefined" !== typeof cell.attr('island-id')) { stephino_rpg_tools.navigation.start('island', cell.attr('island-id')); } }, provision: function(cellX, cellY, successCallback, cellCache) { var radius = 4; var excludedIds = []; var cellCacheIds = []; cellCache.forEach(function(v) { cellCacheIds[cellCacheIds.length] = stephino_rpg_tools.utils.getSnakeLength(v[0], v[1]); }); for (var x = cellX - radius; x <= cellX + radius; x++) { for (var y = cellY - radius; y <= cellY + radius; y++) { var islandId = stephino_rpg_tools.utils.getSnakeLength(x, y); if (0 !== islandId && -1 !== jQuery.inArray(islandId, cellCacheIds)) { excludedIds[excludedIds.length] = islandId; } } } stephino_rpg_tools.ajax('cellsWorld', { x: cellX, y: cellY, radius: radius, exclude: excludedIds }, function(msg) { if (msg.status && "function" === typeof successCallback) { successCallback(msg.result.grid); } }); } } ); stephino_rpg_tools.navigation.setMapHandler(mapHandler); } );});